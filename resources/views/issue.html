{% extends "base_template.html" %}



{% block title %}Farado — Issue{% endblock %}

{% set active_menu = 'issues' %}


{% block styles %}
  <!-- styles -->
{% endblock %}


{% block breadcrumb %}
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item"><a href="/issues">Issues</a></li>
    <li class="breadcrumb-item active" aria-current="page">Issue {{ target_issue.id }}</li>
  </ol>
{% endblock %}


{% block content %}

  <h2 class="page-header">Issue</h2>

  {% if operation_result -%}
    <div class="alert alert-{{ operation_result.kind }} alert-dismissible" role="alert">
      {{- operation_result.caption -}}
    </div>
  {%- endif %}

  <div class="row placeholders">

    <ul class="nav nav-pills mb-3 justify-content-end" id="pillsTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
            class="nav-link active"
            id="pills-view-tab"
            data-bs-toggle="pill"
            data-bs-target="#pills-view"
            type="button"
            role="tab"
            aria-controls="pills-view"
            aria-selected="true">View</button>
      </li>
      <li class="nav-item" role="presentation">
        <button
            class="nav-link {% if not restriction.is_save_enabled %}disabled{% endif %}"
            id="pills-edit-tab"
            data-bs-toggle="pill"
            data-bs-target="#pills-edit"
            type="button"
            role="tab"
            aria-controls="pills-edit"
            {% if not restriction.is_save_enabled %}disabled{% endif %}
            aria-selected="false">Edit</button>
      </li>
    </ul>
    <div class="tab-content" id="pillsTabContent">
      <!-- VIEW -->
      <div
          class="tab-pane fade show active"
          id="pills-view"
          role="tabpanel"
          aria-labelledby="pills-view-tab">

        <!-- Issue.id -->
        <div class="col-12">
          Id: {{ target_issue.id }}
        </div>

        <!-- Issue.caption -->
        <div class="col-12">
          Caption: {{ target_issue.caption }}
        </div>

        <!-- Issue.content -->
        <div class="col-12">
          Content: <div id="contentView"></div>
        </div>

        <!-- Issue.fields -->
        {% for field in target_issue.fields %}
          <div class="col-12">
            {% set field_kind = project_manager.field_kind(field.field_kind_id) %}
            {{- field_kind.caption if field_kind is not none else '—' -}}
            :
            {{ field.value }}
          </div>
        {% endfor %}

        <!-- TODO : Issue.files -->

      </div>

      <!-- EDIT -->
      <div
          class="tab-pane fade"
          id="pills-edit"
          role="tabpanel"
          aria-labelledby="pills-edit-tab">

        <form class="row g-3" action="/issues/issue" method="post">

          <!-- Issue.id -->
          <div class="col-12">
            <label for="inputId" class="form-label">Id</label>
            <input type="text" name="target_issue_id" class="form-control" id="inputId" value="{{ target_issue.id }}" readonly>
          </div>

          <!-- Issue.caption -->
          <div class="col-12">
            <label for="inputCaption" class="form-label">Caption</label>
            <input type="text" name="target_issue_caption" class="form-control" id="inputCaption" value="{{ target_issue.caption }}" required>
          </div>

          <!-- Issue.content -->
          <div class="col-12">
            <label for="contentTab" class="form-label">Content</label>
            <ul class="nav nav-tabs" id="contentTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="content-edit-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#content-edit"
                  type="button"
                  role="tab"
                  aria-controls="content-edit"
                  aria-selected="true">Edit</button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="content-view-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#content-view"
                  type="button"
                  role="tab"
                  aria-controls="content-view"
                  aria-selected="false">View</button>
              </li>
            </ul>
            <div class="tab-content" id="contentTabContent">
              <div
                class="tab-pane fade show active"
                id="content-edit"
                role="tabpanel"
                aria-labelledby="content-edit-tab">
                  <textarea
                    name="target_issue_content"
                    class="form-control"
                    id="textareaContent"
                    rows="9"
                    onchange="contentMarkdownToHtml('contentViewResult')">{{ target_issue.content }}</textarea>
              </div>
              <div
                class="tab-pane fade"
                id="content-view"
                role="tabpanel"
                aria-labelledby="content-view-tab">
                  <div id="contentViewResult"></div>
              </div>
            </div>
          </div>
          
          <!-- Issue.fields -->
          {% if target_issue %}
            {% set fields = target_issue.fields %}
          {% else %}
            {% set fields = new_issue.fields %}
          {% endif %}
          {% for field in fields %}
            <div class="col-12">
              {% set field_kind = project_manager.field_kind(field.field_kind_id) %}
              {% if field_kind %}
                <label
                    for="inputField_{{ field_kind.id }}"
                    class="form-label">{{ field_kind.caption }}</label>
                <input
                    type="text"
                    name="field_kind_{{ field_kind.id }}"
                    class="form-control"
                    id="inputField_{{ field_kind.id }}"
                    value="{{ field.value }}">
              {% endif %}
            </div>
          {% endfor %}

          <!-- TODO : Issue.files -->

          {% if restriction.is_save_enabled %}
            <div class="col-12">
              <button type="submit" id="saveButton" class="btn btn-primary">Save</button>
            </div>
          {% endif %}

        </form>
      </div>
    </div>

  </div>
{% endblock %}



{% block scripts %}
<script src="/static/js/showdown.min.js"></script>

<script>
converter = new showdown.Converter(),
converter.setOption('tables', true);
converter.setOption('tasklists', true);

function contentMarkdownToHtml(id) {
  $("#" + id).html(
    converter.makeHtml(
      $("#textareaContent").val()
    )
  );
}

$(document).ready(function() {
  [].slice.call(document.querySelectorAll('#pillsTab a')).forEach(function (triggerEl) {
    var tabTrigger = new bootstrap.Tab(triggerEl);

    triggerEl.addEventListener('click', function (event) {
      event.preventDefault();
      tabTrigger.show();
    });
  });

  [].slice.call(document.querySelectorAll('#contentTab a')).forEach(function (triggerEl) {
    var tabTrigger = new bootstrap.Tab(triggerEl);

    triggerEl.addEventListener('click', function (event) {
      event.preventDefault();
      tabTrigger.show();
    });
  });

  contentMarkdownToHtml('contentView');
  contentMarkdownToHtml('contentViewResult');
});


</script>
{% endblock %}
